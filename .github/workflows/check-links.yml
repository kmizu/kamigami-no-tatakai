name: Check Links

on:
  # 毎週月曜日の午前3時（UTC）に実行
  schedule:
    - cron: '0 3 * * 1'
  # 手動実行も可能
  workflow_dispatch:
  # PRでも実行
  pull_request:
    paths:
      - '**.md'
      - 'mkdocs.yml'

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install linkchecker

    - name: Build site
      run: mkdocs build --strict

    - name: Start server
      run: |
        python -m http.server 8080 --directory site &
        echo $! > server.pid
        sleep 5

    - name: Check internal links
      run: |
        linkchecker http://localhost:8080 \
          --ignore-url=^mailto: \
          --ignore-url=^https://github.com.* \
          --ignore-url=^https://twitter.com.* \
          --check-html \
          --check-css \
          --output=text \
          --no-warnings \
          || true

    - name: Stop server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

    - name: Create issue if links are broken
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🔗 壊れたリンクが検出されました',
            body: 'リンクチェックで問題が検出されました。詳細は[Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})を確認してください。',
            labels: ['bug', 'documentation']
          }
          github.rest.issues.create(issue)