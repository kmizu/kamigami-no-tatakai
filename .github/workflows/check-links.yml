name: Check Links

on:
  # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 3 * * 1'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  # PRã§ã‚‚å®Ÿè¡Œ
  pull_request:
    paths:
      - '**.md'
      - 'mkdocs.yml'

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install linkchecker

    - name: Build site
      run: mkdocs build --strict

    - name: Start server
      run: |
        python -m http.server 8080 --directory site &
        echo $! > server.pid
        sleep 5

    - name: Check internal links
      run: |
        linkchecker http://localhost:8080 \
          --ignore-url=^mailto: \
          --ignore-url=^https://github.com.* \
          --ignore-url=^https://twitter.com.* \
          --check-html \
          --check-css \
          --output=text \
          --no-warnings \
          || true

    - name: Stop server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

    - name: Create issue if links are broken
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ”— å£Šã‚ŒãŸãƒªãƒ³ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
            body: 'ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯[Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
            labels: ['bug', 'documentation']
          }
          github.rest.issues.create(issue)